<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin | iGo iPhones</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { 
            --primary: #FF4500; 
            --danger: #ef4444; 
            --success: #22c55e; 
            --bg: #f8fafc; 
            --sidebar-bg: #000000; 
        }
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: #000; }

        .sidebar { width: 250px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; z-index: 10; }
        .logo-box { padding: 30px 20px; display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid #222; }
        
        /* Box da Logo iGO */
        .igo-logo { 
            width: 80px; 
            height: 80px; 
            border: 2px solid var(--primary); 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: white; 
            overflow: hidden;
        }
        .igo-logo img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            background: transparent;
        }

        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; color: #aaa; transition: 0.2s; }
        .nav-item i { margin-right: 12px; }
        .nav-item:hover, .nav-item.active { background: #111; color: var(--primary); border-right: 4px solid var(--primary); }

        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .main.active { display: block; }
        
        .cards-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .card .value { font-size: 28px; font-weight: 800; color: #1e293b; }

        .order-card { background: white; border: 1px solid #cbd5e1; border-left: 5px solid var(--primary); border-radius: 10px; padding: 15px; margin-bottom: 10px; }
        .dispatch-controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn-dispatch { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .chat-frame { background: white; border: 1px solid #cbd5e1; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; height: 450px; }
        .chat-body { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
        .msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; max-width: 85%; }
        .msg.admin { background: var(--primary); color: white; align-self: flex-end; }
        .msg.driver { background: #e2e8f0; align-self: flex-start; }

        .form-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        .btn-save { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .monitor-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: 600px; }
        #map { height: 100%; width: 100%; border-radius: 15px; }
        .btn-link { background: #25D366; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-box">
            <div class="igo-logo"><img src="logo.png" alt="iGO!"></div>
            <p style="font-weight: 900; margin-top: 10px;">iGo iPhones</p>
        </div>
        <div class="nav-item active" onclick="nav('dashboard')"><i class="fas fa-home"></i> Painel</div>
        <div class="nav-item" onclick="nav('novo-pedido')"><i class="fas fa-plus-circle"></i> Novo Pedido</div>
        <div class="nav-item" onclick="nav('monitoramento')"><i class="fas fa-map-marked-alt"></i> Monitoramento</div>
        <div class="nav-item" onclick="nav('historico')"><i class="fas fa-history"></i> Hist√≥rico</div>
        <div class="nav-item" onclick="fullReset()" style="color:var(--danger); margin-top:auto"><i class="fas fa-bomb"></i> ZERAR</div>
    </div>

    <div id="dashboard" class="main active">
        <h2>Dashboard</h2>
        <div class="cards-container">
            <div class="card" style="border-left:5px solid var(--success)"><h3>Faturamento</h3><div class="value" id="dash-money">R$ 0,00</div></div>
            <div class="card" style="border-left:5px solid var(--primary)"><h3>Pendentes</h3><div class="value" id="dash-pending">0</div></div>
            <div class="card" style="border-left:5px solid #000"><h3>Em Rota</h3><div class="value" id="dash-active">0</div></div>
        </div>
        <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
            <div><h3>Aguardando</h3><div id="pending-list"></div></div>
            <div class="chat-frame">
                <div style="padding:10px; font-weight:bold; background:#eee;">Chat Central</div>
                <div id="chat-msgs" class="chat-body"></div>
                <div style="padding:10px; display:flex; gap:5px;">
                    <input type="text" id="chat-txt" placeholder="Mensagem..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px;">
                    <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:5px;">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="novo-pedido" class="main">
        <h2>Novo Pedido</h2>
        <div class="form-layout">
            <div>
                <div class="input-group"><label>Cliente</label><input type="text" id="np-name"></div>
                <div class="input-group"><label>Valor (R$)</label><input type="text" id="np-price" oninput="maskMoney(this)"></div>
                <div class="input-group"><label>WhatsApp</label><input type="text" id="np-phone" oninput="maskPhone(this)" maxlength="16"></div>
                <div class="input-group"><label>Endere√ßo</label><input type="text" id="np-addr" onblur="buscarEndereco()"><div id="geo-status" style="font-size:12px;"></div></div>
                <input type="hidden" id="np-lat"><input type="hidden" id="np-lng">
                <button id="btn-create" class="btn-save" onclick="saveOrder()">CRIAR PEDIDO</button>
            </div>
            <div id="map-cadastro" style="height: 350px; border-radius:12px; border:1px solid #ddd;"></div>
        </div>
    </div>

    <div id="monitoramento" class="main">
        <h2>Monitoramento</h2>
        <div class="monitor-layout">
            <div id="monitor-list" style="background:white; padding:10px; border-radius:12px; overflow-y:auto; border:1px solid #ddd;"></div>
            <div id="map"></div>
        </div>
    </div>

    <div id="historico" class="main">
        <h2>Hist√≥rico</h2>
        <table>
            <thead><tr><th>Data</th><th>Cliente</th><th>Valor</th><th>Moto</th><th>A√ß√£o</th></tr></thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>

    <audio id="hornSound" src="https://www.myinstants.com/media/sounds/vuvuzela.mp3"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const socket = io();
        let globalData = null;

        // MAPA NO MODO CLARO (WHITE MAP)
        const lightTiles = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

        const map = L.map('map').setView([-8.0592, -34.8996], 13);
        L.tileLayer(lightTiles, { attribution: '&copy; CARTO' }).addTo(map);

        let markers = {}, routeLayer = L.layerGroup().addTo(map);
        
        const mapCad = L.map('map-cadastro', {zoomControl: false}).setView([-8.0592, -34.8996], 13);
        L.tileLayer(lightTiles, { attribution: '&copy; CARTO' }).addTo(mapCad);
        let cadMarker;

        document.getElementById('chat-txt').addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMsg(); });
        function sendMsg() {
            const t = document.getElementById('chat-txt').value; if(!t.trim()) return;
            socket.emit('send_chat_message', { to: 'admin', text: t, from: 'Admin' });
            document.getElementById('chat-txt').value = '';
        }

        socket.on('new_chat_message', (data) => {
            const box = document.getElementById('chat-msgs');
            const d = document.createElement('div');
            d.className = data.from === 'Admin' ? 'msg admin' : 'msg driver';
            d.innerHTML = `<b>${data.from === 'Admin' ? 'Eu' : data.from}:</b> ${data.text}`;
            box.appendChild(d); box.scrollTop = box.scrollHeight;
        });

        function enviarLinkCliente(id, phone, name) {
            const link = `${window.location.origin}/?id=${id}`;
            const msg = `Ol√° ${name}, a iGo iPhones informa: Pedido saiu! üèçÔ∏è\nAcompanhe aqui: ${link}`;
            window.open(`https://web.whatsapp.com/send?phone=55${phone.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`, '_blank');
        }

        async function buscarEndereco() {
            const addr = document.getElementById('np-addr').value; if(addr.length < 5) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Recife, PE')}`);
            const data = await res.json();
            if(data.length > 0) {
                const lat = data[0].lat, lng = data[0].lon;
                document.getElementById('np-lat').value = lat; document.getElementById('np-lng').value = lng;
                if(cadMarker) mapCad.removeLayer(cadMarker);
                cadMarker = L.marker([lat, lng]).addTo(mapCad); mapCad.setView([lat, lng], 16);
            }
        }

        function nav(id) {
            document.querySelectorAll('.main').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'monitoramento') setTimeout(() => map.invalidateSize(), 200);
            if(id === 'novo-pedido') setTimeout(() => mapCad.invalidateSize(), 200);
        }

        function maskMoney(i) { let v = i.value.replace(/\D/g, "") / 100; i.value = v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        
        // --- FUN√á√ÉO CORRIGIDA: (xx) x xxxx-xxxx ---
        function maskPhone(i) {
            let v = i.value.replace(/\D/g, ""); // Remove tudo que n√£o √© n√∫mero
            if (v.length > 11) v = v.substring(0, 11); // Limita a 11 d√≠gitos

            if (v.length > 0) {
                v = "(" + v;
            }
            if (v.length > 3) {
                v = v.substring(0, 3) + ") " + v.substring(3);
            }
            if (v.length > 6) {
                v = v.substring(0, 6) + " " + v.substring(6);
            }
            if (v.length > 11) {
                v = v.substring(0, 11) + "-" + v.substring(11);
            }
            i.value = v;
        }

        async function refreshData() {
            const res = await fetch('/api/dashboard'); globalData = await res.json();
            document.getElementById('dash-money').innerText = globalData.history.reduce((a, b) => a + (b.price||0), 0).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('dash-pending').innerText = globalData.pendingOrders.length;
            document.getElementById('dash-active').innerText = globalData.activeOrders.length;

            document.getElementById('pending-list').innerHTML = globalData.pendingOrders.map(o => `
                <div class="order-card">
                    <b>${o.clientName}</b><br><small>${o.address}</small>
                    <div class="dispatch-controls">
                        <select id="sel-${o.id}"><option value="">Moto...</option>${globalData.drivers.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}</select>
                        <button class="btn-dispatch" onclick="despachar('${o.id}')">Enviar</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('monitor-list').innerHTML = globalData.activeOrders.map(o => `
                <div style="padding:10px; border-bottom:1px solid #eee;">
                    <b>${o.clientName}</b><br><small>Moto: ${o.driverName}</small>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button onclick="focarRota('${o.id}')" style="flex:1; padding:8px; border-radius:5px; border:1px solid #ddd; background:white;">Mapa</button>
                        <button class="btn-link" onclick="enviarLinkCliente('${o.id}', '${o.phone}', '${o.clientName}')">WhatsApp</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('history-body').innerHTML = globalData.history.map(h => `
                <tr><td>${h.completedAt}</td><td>${h.clientName}</td><td>R$ ${(h.price||0).toFixed(2)}</td><td>${h.driverName}</td><td><button onclick="delHist('${h.id}')" style="color:red; border:none; background:none;">üóëÔ∏è</button></td></tr>
            `).join('');
        }

        async function saveOrder() {
            const btn = document.getElementById('btn-create'); btn.innerText = "‚è≥..."; btn.disabled = true;
            const price = parseFloat(document.getElementById('np-price').value.replace('R$','').replace('.','').replace(',','.').trim());
            await fetch('/register-delivery', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ clientName: document.getElementById('np-name').value, price, phone: document.getElementById('np-phone').value, address: document.getElementById('np-addr').value, lat: document.getElementById('np-lat').value, lng: document.getElementById('np-lng').value }) });
            alert("Pedido Criado!"); document.querySelectorAll('#novo-pedido input').forEach(i => i.value = ''); btn.innerText = "CRIAR PEDIDO"; btn.disabled = false; nav('dashboard'); refreshData();
        }

        async function despachar(id) { const d = document.getElementById('sel-'+id).value; if(!d) return; await fetch('/assign-order', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({orderId: id, driverSocketId: d}) }); refreshData(); }
        
        // SENHA ATUALIZADA: Abraao2026123
        async function delHist(id) { if(prompt("Senha:")==="Abraao2026123") await fetch('/delete-history/'+id, {method:'DELETE'}); refreshData(); }
        async function fullReset() { if(prompt("Senha:")==="Abraao2026123") { await fetch('/api/reset-system', {method:'POST'}); location.reload(); } }

        function focarRota(id) {
            routeLayer.clearLayers(); const o = globalData.activeOrders.find(x => x.id === id);
            if(o) {
                L.marker([o.storeCoords.lat, o.storeCoords.lng], {icon: L.divIcon({html:'<div style="background:red;width:12px;height:12px;border-radius:50%;border:2px solid white"></div>', className:''})}).addTo(routeLayer);
                L.marker([o.destCoords.lat, o.destCoords.lng], {icon: L.divIcon({html:'<div style="background:orange;width:12px;height:12px;border-radius:50%;border:2px solid white"></div>', className:''})}).addTo(routeLayer);
                map.setView([o.destCoords.lat, o.destCoords.lng], 14);
            }
        }

        socket.on('update_map', (data) => {
            if(!markers[data.socketId]) markers[data.socketId] = L.marker([data.lat, data.lng], {icon: L.divIcon({html:'üèçÔ∏è', className:'', iconSize:[30,30]})}).addTo(map);
            else markers[data.socketId].setLatLng([data.lat, data.lng]);
        });
        
        socket.on('driver_online_alert', () => document.getElementById('hornSound').play());
        socket.on('refresh_admin', refreshData);
        refreshData();
    </script>
</body>
</html>
