<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin | Painel Logística</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        :root { --primary: #ff4500; --danger: #ef4444; --success: #22c55e; --bg: #f8fafc; --sidebar-bg: #000000; }
        body { margin: 0; font-family: "Segoe UI", sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 250px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; z-index: 10; }
        .logo-box { padding: 30px 20px; display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid #222; }
        .igo-logo { width: 70px; height: 90px; border: 3px solid var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: black; }
        .igo-logo span { color: white; font-size: 22px; font-weight: 900; }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; color: #aaa; transition: 0.2s; }
        .nav-item i { margin-right: 12px; }
        .nav-item:hover, .nav-item.active { background: #111; color: var(--primary); border-right: 4px solid var(--primary); }
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .main.active { display: block; }
        .cards-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .card .value { font-size: 28px; font-weight: 800; color: #1e293b; }
        .order-card { background: white; border: 1px solid #cbd5e1; border-left: 5px solid var(--primary); border-radius: 10px; padding: 15px; margin-bottom: 10px; }
        .dispatch-controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn-dispatch { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .form-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        #map { height: 500px; width: 100%; border-radius: 15px; border: 1px solid #ddd; }
        .btn-link { background: #25d366; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo-box">
            <div class="igo-logo"><span id="sidebar-logo">iGO!</span></div>
            <p id="store-title" style="font-weight: 900; margin-top: 10px">Carregando...</p>
        </div>
        <div class="nav-item active" onclick="nav('dashboard')"><i class="fas fa-home"></i> Painel</div>
        <div class="nav-item" onclick="nav('novo-pedido')"><i class="fas fa-plus-circle"></i> Novo Pedido</div>
        <div class="nav-item" onclick="nav('monitoramento')"><i class="fas fa-map-marked-alt"></i> Monitoramento</div>
        <div class="nav-item" onclick="nav('historico')"><i class="fas fa-history"></i> Histórico</div>
    </div>

    <div id="dashboard" class="main active">
        <h2>Dashboard</h2>
        <div class="cards-container">
            <div class="card" style="border-left: 5px solid var(--success)"><h3>Faturamento</h3><div class="value" id="dash-money">R$ 0,00</div></div>
            <div class="card" style="border-left: 5px solid var(--primary)"><h3>Pendentes</h3><div class="value" id="dash-pending">0</div></div>
            <div class="card" style="border-left: 5px solid #000"><h3>Em Rota</h3><div class="value" id="dash-active">0</div></div>
        </div>
        <h3>Pedidos Aguardando</h3>
        <div id="pending-list"></div>
    </div>

    <div id="novo-pedido" class="main">
        <h2>Novo Pedido</h2>
        <div class="form-layout">
            <div>
                <div class="input-group"><label>Cliente</label><input type="text" id="np-name"></div>
                <div class="input-group"><label>Valor (R$)</label><input type="text" id="np-price" oninput="maskMoney(this)"></div>
                <div class="input-group"><label>WhatsApp</label><input type="text" id="np-phone" oninput="maskPhone(this)" placeholder="(81) 9 0000-0000"></div>
                <div class="input-group"><label>Endereço</label><input type="text" id="np-addr" onblur="buscarEndereco()"></div>
                <input type="hidden" id="np-lat"><input type="hidden" id="np-lng">
                <button onclick="saveOrder()" style="width:100%; background:var(--primary); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">CRIAR PEDIDO</button>
            </div>
            <div id="map-cadastro" style="height: 400px; border-radius: 12px; border: 1px solid #ddd"></div>
        </div>
    </div>

    <div id="monitoramento" class="main">
        <h2>Monitoramento em Tempo Real</h2>
        <div id="map"></div>
    </div>

    <div id="historico" class="main">
        <h2>Histórico</h2>
        <table><thead><tr><th>Cliente</th><th>Valor</th><th>Moto</th><th>Data</th></tr></thead><tbody id="history-body"></tbody></table>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = "https://logistica-igo.onrender.com";
        const urlParams = new URLSearchParams(window.location.search);
        const STORE_SLUG = urlParams.get('store') || 'igo-iphones';
        
        const socket = io(API_URL);
        socket.emit("join_store", STORE_SLUG);

        if(STORE_SLUG === 'oxeiphone') {
            document.documentElement.style.setProperty('--primary', '#22c55e');
            document.getElementById('sidebar-logo').innerText = 'OXE!';
            document.getElementById('store-title').innerText = 'Oxe iPhone';
        } else if(STORE_SLUG === 'iphone-zero-81') {
            document.documentElement.style.setProperty('--primary', '#3b82f6');
            document.getElementById('sidebar-logo').innerText = 'Z81';
            document.getElementById('store-title').innerText = 'iPhone Zero 81';
        } else {
            document.getElementById('store-title').innerText = 'iGo iPhones';
        }

        const map = L.map("map").setView([-8.05428, -34.8813], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        const mapCad = L.map("map-cadastro").setView([-8.05428, -34.8813], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapCad);
        let cadMarker;

        async function refreshData() {
            try {
                const res = await fetch(`${API_URL}/api/dashboard/${STORE_SLUG}`);
                const data = await res.json();
                
                document.getElementById("dash-money").innerText = data.history.reduce((a, b) => a + parseFloat(b.price), 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
                document.getElementById("dash-pending").innerText = data.pendingOrders.length;
                document.getElementById("dash-active").innerText = data.activeOrders.length;

                document.getElementById("pending-list").innerHTML = data.pendingOrders.map(o => `
                    <div class="order-card">
                        <b>${o.client_name}</b> - R$ ${o.price}<br><small>${o.address}</small>
                        <div class="dispatch-controls">
                            <input type="text" id="moto-${o.id}" placeholder="Nome Motoboy" style="padding:5px; border-radius:5px; border:1px solid #ddd;">
                            <button class="btn-dispatch" onclick="despachar('${o.id}')">Enviar</button>
                        </div>
                    </div>
                `).join("");

                document.getElementById("history-body").innerHTML = data.history.map(h => `
                    <tr><td>${h.client_name}</td><td>R$ ${h.price}</td><td>${h.driver_name}</td><td>${new Date(h.completed_at).toLocaleDateString()}</td></tr>
                `).join("");
            } catch (e) {
                console.error("Erro ao carregar dados:", e);
            }
        }

        async function saveOrder() {
            const clientName = document.getElementById("np-name").value;
            const priceRaw = document.getElementById("np-price").value;
            const phone = document.getElementById("np-phone").value;
            const address = document.getElementById("np-addr").value;
            const lat = document.getElementById("np-lat").value;
            const lng = document.getElementById("np-lng").value;

            if(!clientName || !priceRaw || !address) {
                alert("Preencha Nome, Valor e Endereço!");
                return;
            }

            const price = parseFloat(priceRaw.replace(/[^\d,]/g, "").replace(",", "."));

            try {
                const response = await fetch(`${API_URL}/register-delivery`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        store_slug: STORE_SLUG,
                        clientName, price, phone, address, lat, lng
                    })
                });

                if(response.ok) {
                    alert("✅ Pedido Criado com Sucesso!");
                    document.getElementById("np-name").value = "";
                    document.getElementById("np-price").value = "";
                    document.getElementById("np-phone").value = "";
                    document.getElementById("np-addr").value = "";
                    refreshData();
                    nav('dashboard');
                } else {
                    alert("❌ Erro no servidor ao criar pedido.");
                }
            } catch (err) {
                alert("❌ Erro de conexão: O servidor Render pode estar ligando. Tente novamente em alguns segundos.");
            }
        }

        async function despachar(id) {
            const moto = document.getElementById(`moto-${id}`).value;
            if(!moto) return alert("Digite o nome do motoboy!");
            await fetch(`${API_URL}/assign-order`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId: id, driverName: moto, store_slug: STORE_SLUG })
            });
            refreshData();
        }

        async function buscarEndereco() {
            const addr = document.getElementById("np-addr").value;
            if(!addr) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ", Recife, PE")}`);
            const data = await res.json();
            if(data.length > 0) {
                document.getElementById("np-lat").value = data[0].lat;
                document.getElementById("np-lng").value = data[0].lon;
                if(cadMarker) mapCad.removeLayer(cadMarker);
                cadMarker = L.marker([data[0].lat, data[0].lon]).addTo(mapCad);
                mapCad.setView([data[0].lat, data[0].lon], 16);
            }
        }

        function nav(id) {
            document.querySelectorAll(".main").forEach(d => d.classList.remove("active"));
            document.getElementById(id).classList.add("active");
            if(id === 'monitoramento') setTimeout(() => map.invalidateSize(), 200);
            if(id === 'novo-pedido') setTimeout(() => mapCad.invalidateSize(), 200);
        }

        function maskMoney(i) {
            let v = i.value.replace(/\D/g, "") / 100;
            i.value = v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }

        function maskPhone(i) {
            let v = i.value.replace(/\D/g, "");
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length <= 2) {
                i.value = v;
            } else if (v.length <= 3) {
                i.value = `(${v.substring(0, 2)}) ${v.substring(2)}`;
            } else if (v.length <= 7) {
                i.value = `(${v.substring(0, 2)}) ${v.substring(2, 3)} ${v.substring(3)}`;
            } else {
                i.value = `(${v.substring(0, 2)}) ${v.substring(2, 3)} ${v.substring(3, 7)}-${v.substring(7)}`;
            }
        }

        socket.on("refresh_admin", refreshData);
        window.onload = refreshData;
    </script>
</body>
</html>
