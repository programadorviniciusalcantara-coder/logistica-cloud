<body>
    <div class="sidebar">
        <div class="logo-box">
            <div id="logo-container"><canvas id="logoCanvas"></canvas></div>
            <p style="font-weight: 900; margin-top: 15px; color: var(--primary); letter-spacing: 1px;">iGo iPhones</p>
        </div>
        <div class="nav-item active" onclick="nav('dashboard')"><i class="fas fa-home"></i> Painel Geral</div>
        <div class="nav-item" onclick="nav('novo-pedido')"><i class="fas fa-plus-circle"></i> Novo Pedido</div>
        <div class="nav-item" onclick="nav('monitoramento')"><i class="fas fa-map-marked-alt"></i> Rastreio</div>
        <div class="nav-item" onclick="nav('historico')"><i class="fas fa-history"></i> Relat√≥rios</div>
        <div class="nav-item" onclick="location.reload()" style="color:var(--danger); margin-top:auto"><i class="fas fa-sync-alt"></i> Atualizar</div>
    </div>

    <div id="dashboard" class="main active">
        <h2>Vis√£o Geral</h2>
        <div class="cards-container">
            <div class="card" style="border-left:5px solid var(--success)">
                <h3>Faturamento do Dia</h3><div class="value" id="dash-money">R$ 0,00</div><i class="fas fa-dollar-sign card-icon" style="color:var(--success)"></i>
            </div>
            <div class="card" style="border-left:5px solid var(--primary)">
                <h3>Pedidos Pendentes</h3><div class="value" id="dash-pending">0</div><i class="fas fa-clock card-icon" style="color:var(--primary)"></i>
            </div>
            <div class="card" style="border-left:5px solid #111">
                <h3>Motoboys Online</h3><div class="value" id="dash-drivers">0</div><i class="fas fa-motorcycle card-icon" style="color:#111"></i>
            </div>
        </div>
        <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap: 30px;">
            <div>
                <h3 style="margin-bottom:20px; color:#6B7280; font-size:14px; text-transform:uppercase; font-weight:700;">Aguardando Motoboy</h3>
                <div id="pending-list"></div>
            </div>
            <div class="chat-frame" style="background:white; border-radius:16px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05);">
                <h3 style="margin-top:0; color:#111;">Chat Central</h3>
                <div id="chat-msgs" style="height:300px; overflow-y:auto; background:#F9FAFB; border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid #E5E7EB;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="chat-txt" placeholder="Mensagem..." style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px;">
                    <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="novo-pedido" class="main">
        <h2>Cadastrar Entrega</h2>
        <div class="form-layout">
            <div style="background:white; padding:30px; border-radius:20px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.05);">
                <div class="input-group"><label>Nome do Cliente</label><input type="text" id="np-name" placeholder="Ex: Maria Silva"></div>
                <div class="input-group"><label>Valor (R$)</label><input type="text" id="np-price" oninput="maskMoney(this)" placeholder="R$ 0,00"></div>
                <div class="input-group"><label>WhatsApp</label><input type="text" id="np-phone" oninput="maskPhone(this)" maxlength="16" placeholder="(81) 9 0000-0000"></div>
                
                <div class="input-group"><label>Endere√ßo Completo</label><input type="text" id="np-addr" onblur="buscarEndereco()" placeholder="Rua, N√∫mero, Bairro - Recife"></div>
                
                <input type="hidden" id="np-lat" value="0"><input type="hidden" id="np-lng" value="0">
                <button id="btn-create" class="btn-save" onclick="saveOrder()">CRIAR PEDIDO E RASTREIO</button>
            </div>
            <div id="map-cadastro"></div>
        </div>
    </div>

    <div id="monitoramento" class="main">
        <h2>Monitoramento em Tempo Real</h2>
        <div style="display: grid; grid-template-columns: 350px 1fr; gap: 30px;">
            <div id="monitor-list" style="background:white; padding:20px; border-radius:20px; overflow-y:auto; height: 600px; box-shadow:0 4px 6px rgba(0,0,0,0.05);"></div>
            <div id="map"></div>
        </div>
    </div>

    <div id="historico" class="main">
        <h2>Hist√≥rico de Entregas</h2>
        <table><thead><tr><th>Data</th><th>Cliente</th><th>Valor</th><th>Motoboy</th><th>A√ß√£o</th></tr></thead><tbody id="history-body"></tbody></table>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = "https://logistica-igo.onrender.com"; 
        const STORE_SLUG = "igo-iphones";
        const socket = io(API_URL);
        let globalData = { pendingOrders: [], activeOrders: [], drivers: [], history: [] };
        let map, mapCad, routeLayer, markers = {};
        const lightTile = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

        const canvas = document.getElementById('logoCanvas');
        const ctx = canvas.getContext('2d');
        const img = new Image(); img.src = 'logo.png'; 
        img.onload = () => { canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); const d = ctx.getImageData(0, 0, canvas.width, canvas.height); for (let i = 0; i < d.data.length; i += 4) if (d.data[i] < 45) d.data[i+3] = 0; ctx.putImageData(d, 0, 0); };

        function initMaps() {
            if (!map) { map = L.map('map', { zoomControl: false }).setView([-8.0592, -34.8996], 13); L.tileLayer(lightTile).addTo(map); routeLayer = L.layerGroup().addTo(map); }
            if (!mapCad) { mapCad = L.map('map-cadastro', { zoomControl: false }).setView([-8.0592, -34.8996], 13); L.tileLayer(lightTile).addTo(mapCad); }
        }

        window.onload = () => { initMaps(); socket.emit("join_store", STORE_SLUG); refreshData(); };
        
        // CORRE√á√ÉO: For√ßa mapa a aparecer
        function nav(id) { 
            document.querySelectorAll('.main').forEach(d => d.classList.remove('active')); 
            document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            setTimeout(() => { if(map) map.invalidateSize(); if(mapCad) mapCad.invalidateSize(); }, 200);
        }

        async function refreshData() {
            try {
                const res = await fetch(`${API_URL}/api/dashboard/${STORE_SLUG}`);
                globalData = await res.json();
                
                document.getElementById('dash-money').innerText = globalData.history.reduce((a, b) => a + parseFloat(b.price||0), 0).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('dash-pending').innerText = globalData.pendingOrders.length;
                document.getElementById('dash-drivers').innerText = (globalData.drivers || []).length; 

                const driversOptions = (globalData.drivers || []).map(d => `<option value="${d.name}|${d.phone}">${d.name} (Online)</option>`).join('');
                
                document.getElementById('pending-list').innerHTML = globalData.pendingOrders.map(o => `
                    <div class="order-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="font-weight:800; font-size:16px;">${o.client_name}</span>
                            <span style="background:#f3f4f6; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:700;">R$ ${parseFloat(o.price).toFixed(2)}</span>
                        </div>
                        <div style="color:#6B7280; font-size:13px; margin-bottom:15px;"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${o.address}</div>
                        <div style="display:flex; gap:10px;">
                            <select id="sel-${o.id}">
                                <option value="">Selecione...</option>
                                ${driversOptions}
                            </select>
                            <button class="btn-dispatch" onclick="despachar('${o.id}')"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                `).join('') || '<p style="color:#aaa; text-align:center;">Sem pedidos.</p>';

                document.getElementById('monitor-list').innerHTML = globalData.activeOrders.map(o => `
                    <div style="padding:20px; border-bottom:1px solid #eee; background:#F9FAFB; border-radius:12px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${o.client_name}</b>
                            <span style="color:var(--success); font-weight:bold;">Em Rota</span>
                        </div>
                        <div style="background: #FFF4EC; color: #FF4500; font-weight:900; font-size:14px; padding:5px; text-align:center; border-radius:8px; margin: 10px 0;">C√ìDIGO: ${o.delivery_code || '----'}</div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button onclick="focarRota('${o.id}')" style="flex:1; padding:10px; border:1px solid #E5E7EB; background:white; border-radius:8px; font-weight:bold;">Mapa</button>
                            <button onclick="enviarLink('${o.phone}', '${o.client_name}', '${o.id}')" style="flex:1; padding:10px; border:none; background:#25D366; color:white; border-radius:8px; font-weight:bold;"><i class="fab fa-whatsapp"></i> Link</button>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('history-body').innerHTML = globalData.history.map(h => `<tr><td>${new Date(h.completed_at).toLocaleDateString()}</td><td>${h.client_name}</td><td>R$ ${parseFloat(h.price).toFixed(2)}</td><td>${h.driver_name}</td><td><button onclick="delHist('${h.id}')" style="color:red;border:none;background:none"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            } catch (e) { console.error(e); }
        }

        async function saveOrder() {
            const btn = document.getElementById('btn-create');
            
            // VALIDA√á√ÉO ANTI-OCEANO
            const lat = document.getElementById('np-lat').value;
            const lng = document.getElementById('np-lng').value;
            
            if(lat == 0 || lng == 0 || lat == "0") {
                alert("‚ùå ERRO: Endere√ßo n√£o localizado no mapa!\n\nPor favor, digite o endere√ßo e CLIQUE FORA do campo para buscar.");
                return;
            }

            btn.innerText = "‚è≥ SALVANDO..."; btn.disabled = true;
            try {
                await fetch(`${API_URL}/register-delivery`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ store_slug: STORE_SLUG, clientName: document.getElementById('np-name').value, price: parseFloat(document.getElementById('np-price').value.replace('R$','').replace('.','').replace(',','.'))||0, phone: document.getElementById('np-phone').value, address: document.getElementById('np-addr').value, lat: lat, lng: lng }) });
                alert("‚úÖ PEDIDO CRIADO!"); 
                document.querySelectorAll('#novo-pedido input').forEach(i => i.value = ''); 
                document.getElementById('np-lat').value = "0"; // Reseta
                nav('dashboard'); refreshData();
            } catch (e) { alert("Erro ao salvar."); }
            btn.innerText = "CRIAR PEDIDO"; btn.disabled = false;
        }

        async function despachar(id) {
            const val = document.getElementById('sel-'+id).value;
            if(!val) return alert("Selecione um motoboy!");
            const [dName, dPhone] = val.split('|');
            await fetch(`${API_URL}/assign-order`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ store_slug: STORE_SLUG, orderId: id, driverName: dName, driverPhone: dPhone }) });
            refreshData();
        }

        function enviarLink(phone, name, orderId) {
            const link = "https://jv-log.vercel.app";
            const msg = `Ol√° *${name}*! üëã\n\nSeu pedido iGO saiu para entrega!\n\nüîê C√≥digo de Seguran√ßa: *${globalData.activeOrders.find(o=>o.id==orderId)?.delivery_code || '????'}*\n\nüìç Rastreie: ${link}?id=${orderId}`;
            window.open(`https://wa.me/55${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // CORRE√á√ÉO DO MAPA CINZA AO CLICAR NO BOT√ÉO
        function focarRota(id) {
            nav('monitoramento'); // Vai para a aba
            
            setTimeout(() => {
                routeLayer.clearLayers(); 
                const o = globalData.activeOrders.find(x => x.id === id);
                if(o) {
                    L.marker([-8.0592, -34.8996]).addTo(routeLayer); 
                    L.marker([o.lat, o.lng]).addTo(routeLayer); 
                    map.setView([o.lat, o.lng], 14);
                    map.invalidateSize(); // For√ßa redesenho
                }
            }, 300);
        }

        async function buscarEndereco() {
            const addr = document.getElementById('np-addr').value; if(addr.length<5) return;
            // Busca mais precisa com 'Recife, Pernambuco'
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Recife, Pernambuco, Brazil')}`);
            const data = await res.json();
            if(data.length > 0) {
                const { lat, lon } = data[0];
                document.getElementById('np-lat').value = lat; 
                document.getElementById('np-lng').value = lon;
                if(window.cMark) mapCad.removeLayer(window.cMark);
                window.cMark = L.circleMarker([lat, lon], { radius: 8, color: '#FF4500', fillColor: '#FF4500', fillOpacity: 1 }).addTo(mapCad);
                mapCad.setView([lat, lon], 16);
            } else {
                alert("Endere√ßo n√£o encontrado no mapa! Tente adicionar o bairro.");
                document.getElementById('np-lat').value = 0;
            }
        }
        
        async function delHist(id) { if(prompt("Senha:")==="Abraao2026123") { await fetch(`${API_URL}/delete-history/${id}`, {method:'DELETE'}); refreshData(); } }
        function maskMoney(i) { let v = i.value.replace(/\D/g, "") / 100; i.value = v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function maskPhone(i) { let v = i.value.replace(/\D/g,""); if(v.length>11)v=v.substring(0,11); if(v.length>0)v="("+v; if(v.length>3)v=v.substring(0,3)+") "+v.substring(3); if(v.length>6)v=v.substring(0,6)+" "+v.substring(6); if(v.length>11)v=v.substring(0,11)+"-"+v.substring(11); i.value = v; }
        
        socket.on('refresh_admin', refreshData);
        socket.on('update_map', (d) => { if(!markers[d.phone]) markers[d.phone] = L.marker([d.lat, d.lng]).addTo(map); else markers[d.phone].setLatLng([d.lat, d.lng]); });
        function sendMsg() { const t = document.getElementById('chat-txt').value; if(!t.trim()) return; socket.emit('send_chat_message', { to: 'admin', text: t, from: 'Admin' }); document.getElementById('chat-txt').value = ''; }
        socket.on('new_chat_message', (d) => { const b=document.getElementById('chat-msgs'); b.innerHTML+=`<div style="margin-bottom:10px;"><b>${d.from}:</b> ${d.text}</div>`; b.scrollTop=b.scrollHeight; });
    </script>
</body>
</html>
