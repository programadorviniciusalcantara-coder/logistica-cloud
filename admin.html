<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin | iGo iPhones</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { 
            --primary: #FF4500; 
            --danger: #ef4444; 
            --success: #22c55e; 
            --bg: #FFFFFF; 
            --sidebar-bg: #000000; 
        }
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: #000; }

        /* Sidebar */
        .sidebar { width: 250px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; z-index: 100; border-right: 1px solid #222; }
        .logo-box { padding: 30px 20px; display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid #222; }
        .igo-logo { width: 80px; height: 80px; border: 2px solid var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden; }
        .igo-logo img { width: 100%; height: 100%; object-fit: contain; }

        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; color: #aaa; transition: 0.2s; font-weight: 600; }
        .nav-item i { margin-right: 12px; }
        .nav-item:hover, .nav-item.active { background: #111; color: var(--primary); border-right: 4px solid var(--primary); }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; height: 100vh; box-sizing: border-box; }
        .main.active { display: block; }
        
        .cards-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card .value { font-size: 28px; font-weight: 800; color: #000; }

        /* Pedidos */
        .order-card { background: white; border: 1px solid #eee; border-left: 5px solid var(--primary); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-dispatch { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Mapas - Altura Garantida */
        #map, #map-cadastro { width: 100%; border-radius: 15px; border: 1px solid #eee; background: #f0f0f0; }
        #map { height: 600px; }
        #map-cadastro { height: 400px; }

        .form-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #64748b; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        .btn-save { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-box">
            <div class="igo-logo"><img src="logo.png" alt="iGO"></div>
            <p style="font-weight: 900; margin-top: 15px; letter-spacing: 1px;">iGo iPhones</p>
        </div>
        <div class="nav-item active" onclick="nav('dashboard')"><i class="fas fa-home"></i> Painel</div>
        <div class="nav-item" onclick="nav('novo-pedido')"><i class="fas fa-plus-circle"></i> Novo Pedido</div>
        <div class="nav-item" onclick="nav('monitoramento')"><i class="fas fa-map-marked-alt"></i> Monitoramento</div>
        <div class="nav-item" onclick="nav('historico')"><i class="fas fa-history"></i> Histórico</div>
        <div class="nav-item" onclick="fullReset()" style="color:var(--danger); margin-top:auto"><i class="fas fa-bomb"></i> ZERAR SISTEMA</div>
    </div>

    <div id="dashboard" class="main active">
        <h2 style="font-weight: 900;">Painel de Controle</h2>
        <div class="cards-container">
            <div class="card" style="border-left:5px solid var(--success)"><h3>Faturamento</h3><div class="value" id="dash-money">R$ 0,00</div></div>
            <div class="card" style="border-left:5px solid var(--primary)"><h3>Pendentes</h3><div class="value" id="dash-pending">0</div></div>
            <div class="card" style="border-left:5px solid #000"><h3>Em Rota</h3><div class="value" id="dash-active">0</div></div>
        </div>
        <h3>Pedidos Aguardando</h3>
        <div id="pending-list" style="min-height: 100px;">
            </div>
    </div>

    <div id="novo-pedido" class="main">
        <h2 style="font-weight: 900;">Novo Pedido</h2>
        <div class="form-layout">
            <div>
                <div class="input-group"><label>Cliente</label><input type="text" id="np-name"></div>
                <div class="input-group"><label>Valor da Venda</label><input type="text" id="np-price" oninput="maskMoney(this)"></div>
                <div class="input-group"><label>WhatsApp</label><input type="text" id="np-phone" oninput="maskPhone(this)" maxlength="16"></div>
                <div class="input-group"><label>Endereço em Recife</label><input type="text" id="np-addr" onblur="buscarEndereco()"></div>
                <input type="hidden" id="np-lat"><input type="hidden" id="np-lng">
                <button id="btn-create" class="btn-save" onclick="saveOrder()">CRIAR E DESPACHAR</button>
            </div>
            <div id="map-cadastro"></div>
        </div>
    </div>

    <div id="monitoramento" class="main">
        <h2 style="font-weight: 900;">Monitoramento em Tempo Real</h2>
        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
            <div id="monitor-list" style="background: white; border: 1px solid #eee; border-radius: 12px; height: 600px; overflow-y: auto; padding: 10px;"></div>
            <div id="map"></div>
        </div>
    </div>

    <div id="historico" class="main">
        <h2 style="font-weight: 900;">Histórico</h2>
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden;">
            <thead style="background: #f8fafc;"><tr><th style="padding: 15px; text-align: left;">Data</th><th style="padding: 15px; text-align: left;">Cliente</th><th style="padding: 15px; text-align: left;">Valor</th><th style="padding: 15px; text-align: left;">Moto</th></tr></thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const socket = io();
        let globalData = { pendingOrders: [], activeOrders: [], drivers: [], history: [] };
        let map, mapCad, cadMarker;
        const lightTile = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

        // Inicialização de Mapas
        function initMaps() {
            if (!map) {
                map = L.map('map', { zoomControl: false }).setView([-8.0592, -34.8996], 13);
                L.tileLayer(lightTile).addTo(map);
            }
            if (!mapCad) {
                mapCad = L.map('map-cadastro', { zoomControl: false }).setView([-8.0592, -34.8996], 13);
                L.tileLayer(lightTile).addTo(mapCad);
            }
        }

        // Navegação entre abas
        function nav(id) {
            document.querySelectorAll('.main').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Corrige o bug do Leaflet carregar cinza
            setTimeout(() => {
                if (id === 'monitoramento' && map) map.invalidateSize();
                if (id === 'novo-pedido' && mapCad) mapCad.invalidateSize();
            }, 300);
        }

        // Atualizar os dados do Dashboard
        async function refreshData() {
            try {
                const res = await fetch('/api/dashboard');
                globalData = await res.json();
                
                // Atualiza Cards
                document.getElementById('dash-money').innerText = globalData.history.reduce((a, b) => a + (b.price||0), 0).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('dash-pending').innerText = globalData.pendingOrders.length;
                document.getElementById('dash-active').innerText = globalData.activeOrders.length;

                // Limpa e reconstrói a lista de Pendentes
                const pendingContainer = document.getElementById('pending-list');
                pendingContainer.innerHTML = ''; 
                if (globalData.pendingOrders.length === 0) {
                    pendingContainer.innerHTML = '<p style="color:#999">Nenhum pedido aguardando.</p>';
                } else {
                    globalData.pendingOrders.forEach(o => {
                        const div = document.createElement('div');
                        div.className = 'order-card';
                        div.innerHTML = `
                            <b>${o.clientName}</b><br><small>${o.address}</small>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <select id="sel-${o.id}" style="padding:5px; border-radius:5px; border:1px solid #ddd; flex:1;">
                                    <option value="">Escolha o Motoboy...</option>
                                    ${globalData.drivers.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                                </select>
                                <button class="btn-dispatch" onclick="despachar('${o.id}')">Enviar</button>
                            </div>
                        `;
                        pendingContainer.appendChild(div);
                    });
                }
            } catch (e) { console.error("Erro no refresh:", e); }
        }

        // Criar Pedido
        async function saveOrder() {
            const btn = document.getElementById('btn-create');
            const data = {
                clientName: document.getElementById('np-name').value,
                price: parseFloat(document.getElementById('np-price').value.replace('R$','').replace('.','').replace(',','.').trim()) || 0,
                phone: document.getElementById('np-phone').value,
                address: document.getElementById('np-addr').value,
                lat: document.getElementById('np-lat').value,
                lng: document.getElementById('np-lng').value
            };

            if (!data.clientName || !data.address) return alert("Preencha os campos obrigatórios!");

            btn.innerText = "⏳ Criando..."; btn.disabled = true;

            try {
                const response = await fetch('/register-delivery', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert("Pedido Criado com Sucesso!");
                    // Limpa formulário
                    document.querySelectorAll('#novo-pedido input').forEach(i => i.value = '');
                    btn.innerText = "CRIAR E DESPACHAR"; btn.disabled = false;
                    nav('dashboard');
                    await refreshData(); // Força a atualização da lista
                }
            } catch (err) { alert("Erro ao conectar ao servidor!"); btn.disabled = false; }
        }

        async function despachar(id) {
            const driverId = document.getElementById('sel-' + id).value;
            if (!driverId) return alert("Selecione um motoboy!");
            await fetch('/assign-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ orderId: id, driverSocketId: driverId })
            });
            refreshData();
        }

        // Busca de Endereço no Mapa
        async function buscarEndereco() {
            const addr = document.getElementById('np-addr').value;
            if (addr.length < 5) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Recife, PE')}`);
            const data = await res.json();
            if (data.length > 0) {
                const lat = data[0].lat, lng = data[0].lon;
                document.getElementById('np-lat').value = lat;
                document.getElementById('np-lng').value = lng;
                if (cadMarker) mapCad.removeLayer(cadMarker);
                cadMarker = L.circleMarker([lat, lng], { radius: 8, color: '#FF4500', fillColor: '#FF4500', fillOpacity: 1 }).addTo(mapCad);
                mapCad.setView([lat, lng], 16);
            }
        }

        // Máscaras
        function maskMoney(i) { let v = i.value.replace(/\D/g, "") / 100; i.value = v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function maskPhone(i) {
            let v = i.value.replace(/\D/g, "");
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length > 0) v = "(" + v;
            if (v.length > 3) v = v.substring(0, 3) + ") " + v.substring(3);
            if (v.length > 6) v = v.substring(0, 6) + " " + v.substring(6);
            if (v.length > 11) v = v.substring(0, 11) + "-" + v.substring(11);
            i.value = v;
        }

        // Resetar Sistema
        async function fullReset() {
            if(prompt("Senha Master:") === "Abraao2026123") {
                await fetch('/api/reset-system', { method: 'POST' });
                location.reload();
            }
        }

        // Inicializa tudo
        window.onload = () => {
            initMaps();
            refreshData();
        };

        socket.on('refresh_admin', refreshData);
    </script>
</body>
</html>
