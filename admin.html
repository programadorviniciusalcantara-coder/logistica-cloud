<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin | iGo iPhones</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #FF4500; --bg: #FFFFFF; --sidebar-bg: #000000; --success: #22c55e; --danger: #ef4444; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: #000; }
        .sidebar { width: 250px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; z-index: 100; border-right: 1px solid #222; }
        .logo-box { padding: 30px 20px; display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid #222; }
        #logo-container { width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; color: #aaa; transition: 0.2s; font-weight: 600; }
        .nav-item:hover, .nav-item.active { background: #111; color: var(--primary); border-right: 4px solid var(--primary); }
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; height: 100vh; box-sizing: border-box; }
        .main.active { display: block; }
        .cards-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card .value { font-size: 28px; font-weight: 800; color: #000; }
        .chat-frame { background: white; border: 1px solid #eee; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; height: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .chat-body { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; background: #fdfdfd; }
        .msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; max-width: 85%; font-size: 13px; }
        .msg.admin { background: var(--primary); color: white; align-self: flex-end; }
        .msg.driver { background: #f1f5f9; color: #000; align-self: flex-start; border: 1px solid #e2e8f0; }
        #map, #map-cadastro { width: 100%; height: 500px !important; min-height: 500px !important; border-radius: 15px; border: 1px solid #eee; background: #e5e5e5; display: block; position: relative; z-index: 1; }
        .order-card { background: white; border: 1px solid #eee; border-left: 5px solid var(--primary); border-radius: 10px; padding: 15px; margin-bottom: 10px; }
        .form-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px; color: #64748b; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        .btn-save, .btn-dispatch { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-dispatch { padding: 10px; width: auto; }
        
        /* Estilo do Dropdown */
        select { padding: 10px; border-radius: 5px; border: 1px solid #ddd; flex: 1; font-weight: bold; background: white; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo-box"><div id="logo-container"><canvas id="logoCanvas"></canvas></div><p style="font-weight: 900; margin-top: 15px; color: var(--primary);">iGo iPhones</p></div>
        <div class="nav-item active" onclick="nav('dashboard')"><i class="fas fa-home"></i> Painel</div>
        <div class="nav-item" onclick="nav('novo-pedido')"><i class="fas fa-plus-circle"></i> Novo Pedido</div>
        <div class="nav-item" onclick="nav('monitoramento')"><i class="fas fa-map-marked-alt"></i> Monitoramento</div>
        <div class="nav-item" onclick="nav('historico')"><i class="fas fa-history"></i> Histórico</div>
        <div class="nav-item" onclick="location.reload()" style="color:var(--danger); margin-top:auto"><i class="fas fa-sync"></i> Atualizar</div>
    </div>

    <div id="dashboard" class="main active">
        <h2 style="font-weight: 900;">Painel de Controle</h2>
        <div class="cards-container">
            <div class="card" style="border-left:5px solid var(--success)"><h3>Faturamento</h3><div class="value" id="dash-money">R$ 0,00</div></div>
            <div class="card" style="border-left:5px solid var(--primary)"><h3>Pendentes</h3><div class="value" id="dash-pending">0</div></div>
            <div class="card" style="border-left:5px solid #000"><h3>Motoboys Online</h3><div class="value" id="dash-drivers">0</div></div>
        </div>
        <div style="display:grid; grid-template-columns: 1.2fr 1fr; gap: 25px;">
            <div><h3>Pedidos Aguardando</h3><div id="pending-list"></div></div>
            <div class="chat-frame">
                <div style="padding:15px; font-weight:bold; background:#000; color: #fff;">Chat Central</div>
                <div id="chat-msgs" class="chat-body"></div>
                <div style="padding:10px; display:flex; gap:5px; background: #f8fafc; border-top: 1px solid #eee;">
                    <input type="text" id="chat-txt" placeholder="Mensagem..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px; outline:none;">
                    <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:5px; font-weight:bold;">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="novo-pedido" class="main">
        <h2 style="font-weight: 900;">Novo Pedido</h2>
        <div class="form-layout">
            <div>
                <div class="input-group"><label>CLIENTE</label><input type="text" id="np-name" placeholder="Nome Completo"></div>
                <div class="input-group"><label>VALOR (R$)</label><input type="text" id="np-price" oninput="maskMoney(this)" placeholder="R$ 0,00"></div>
                <div class="input-group"><label>WHATSAPP</label><input type="text" id="np-phone" oninput="maskPhone(this)" maxlength="16" placeholder="(81) 9 ...."></div>
                <div class="input-group"><label>ENDEREÇO</label><input type="text" id="np-addr" onblur="buscarEndereco()" placeholder="Rua, Bairro, Número"></div>
                <input type="hidden" id="np-lat"><input type="hidden" id="np-lng">
                <button id="btn-create" class="btn-save" onclick="saveOrder()">CRIAR PEDIDO</button>
            </div>
            <div id="map-cadastro"></div>
        </div>
    </div>

    <div id="monitoramento" class="main">
        <h2 style="font-weight: 900;">Monitoramento</h2>
        <div style="display: grid; grid-template-columns: 320px 1fr; gap: 20px;">
            <div id="monitor-list" style="background:white; padding:10px; border-radius:12px; overflow-y:auto; border:1px solid #eee; height: 600px;"></div>
            <div id="map"></div>
        </div>
    </div>

    <div id="historico" class="main">
        <h2 style="font-weight: 900;">Histórico</h2>
        <table style="width: 100%; border-collapse: collapse; background: white;"><tbody id="history-body"></tbody></table>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = "https://logistica-igo.onrender.com"; 
        const STORE_SLUG = "igo-iphones";
        const socket = io(API_URL);
        let globalData = { pendingOrders: [], activeOrders: [], drivers: [], history: [] };
        let map, mapCad, routeLayer, markers = {};
        const lightTile = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

        const canvas = document.getElementById('logoCanvas');
        const ctx = canvas.getContext('2d');
        const img = new Image(); img.src = 'logo.png'; 
        img.onload = () => { canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); const d = ctx.getImageData(0, 0, canvas.width, canvas.height); for (let i = 0; i < d.data.length; i += 4) if (d.data[i] < 45) d.data[i+3] = 0; ctx.putImageData(d, 0, 0); };

        function initMaps() {
            if (!map) { map = L.map('map', { zoomControl: false }).setView([-8.0592, -34.8996], 13); L.tileLayer(lightTile).addTo(map); routeLayer = L.layerGroup().addTo(map); }
            if (!mapCad) { mapCad = L.map('map-cadastro', { zoomControl: false }).setView([-8.0592, -34.8996], 13); L.tileLayer(lightTile).addTo(mapCad); }
        }

        window.onload = () => { initMaps(); socket.emit("join_store", STORE_SLUG); refreshData(); };
        function nav(id) { document.querySelectorAll('.main').forEach(d => d.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active')); document.getElementById(id).classList.add('active'); setTimeout(() => { if(map) map.invalidateSize(); if(mapCad) mapCad.invalidateSize(); }, 300); }

        async function refreshData() {
            try {
                const res = await fetch(`${API_URL}/api/dashboard/${STORE_SLUG}`);
                globalData = await res.json();
                
                document.getElementById('dash-money').innerText = globalData.history.reduce((a, b) => a + parseFloat(b.price||0), 0).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('dash-pending').innerText = globalData.pendingOrders.length;
                document.getElementById('dash-drivers').innerText = (globalData.drivers || []).length; 

                // --- CRIA A LISTA DE OPÇÕES DE MOTOBOYS ---
                const driversOptions = (globalData.drivers || []).map(d => `<option value="${d.name}|${d.phone}">${d.name} (Online)</option>`).join('');
                
                // --- INSERE O SELECT (DROPDOWN) NO LUGAR DOS INPUTS ---
                document.getElementById('pending-list').innerHTML = globalData.pendingOrders.map(o => `
                    <div class="order-card">
                        <b>${o.client_name}</b><br><small>${o.address}</small>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <select id="sel-${o.id}">
                                <option value="">Selecione Motoboy...</option>
                                ${driversOptions}
                            </select>
                            <button class="btn-dispatch" onclick="despachar('${o.id}')">Enviar</button>
                        </div>
                    </div>
                `).join('') || '<p style="color:#aaa; text-align:center;">Sem pedidos pendentes.</p>';

                document.getElementById('monitor-list').innerHTML = globalData.activeOrders.map(o => `
                    <div style="padding:15px; border-bottom:1px solid #eee;">
                        <b>${o.client_name}</b><br><small>Moto: ${o.driver_name}</small>
                        <div style="display:flex; gap:5px; margin-top:10px;"><button onclick="focarRota('${o.id}')" style="flex:1; padding:8px; border:1px solid #eee; background:#fff;">Ver no Mapa</button></div>
                    </div>
                `).join('');
                
                document.getElementById('history-body').innerHTML = globalData.history.map(h => `<tr><td>${new Date(h.completed_at).toLocaleDateString()}</td><td>${h.client_name}</td><td>R$ ${parseFloat(h.price).toFixed(2)}</td><td>${h.driver_name}</td></tr>`).join('');
            } catch (e) { console.error(e); }
        }

        async function saveOrder() {
            const btn = document.getElementById('btn-create'); btn.innerText = "⏳..."; btn.disabled = true;
            try {
                await fetch(`${API_URL}/register-delivery`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ store_slug: STORE_SLUG, clientName: document.getElementById('np-name').value, price: parseFloat(document.getElementById('np-price').value.replace('R$','').replace('.','').replace(',','.'))||0, phone: document.getElementById('np-phone').value, address: document.getElementById('np-addr').value, lat: document.getElementById('np-lat').value, lng: document.getElementById('np-lng').value }) });
                alert("Criado!"); document.querySelectorAll('#novo-pedido input').forEach(i => i.value = ''); nav('dashboard'); refreshData();
            } catch (e) { alert("Erro ao salvar."); }
            btn.innerText = "CRIAR PEDIDO"; btn.disabled = false;
        }

        async function despachar(id) {
            const val = document.getElementById('sel-'+id).value;
            if(!val) return alert("Selecione um motoboy da lista!");
            const [dName, dPhone] = val.split('|'); // Separa nome e telefone
            
            await fetch(`${API_URL}/assign-order`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ store_slug: STORE_SLUG, orderId: id, driverName: dName, driverPhone: dPhone }) });
            refreshData();
        }

        async function buscarEndereco() {
            const addr = document.getElementById('np-addr').value; if(addr.length<5) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Recife, PE')}`);
            const data = await res.json(); if(data.length){ document.getElementById('np-lat').value = data[0].lat; document.getElementById('np-lng').value = data[0].lon; if(window.c) mapCad.removeLayer(window.c); window.c = L.circleMarker([data[0].lat, data[0].lon], {radius:8, color:'#FF4500'}).addTo(mapCad); mapCad.setView([data[0].lat, data[0].lon], 16); }
        }

        function maskMoney(i) { let v = i.value.replace(/\D/g, "") / 100; i.value = v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function maskPhone(i) { let v = i.value.replace(/\D/g,""); if(v.length>11)v=v.substring(0,11); if(v.length>0)v="("+v; if(v.length>3)v=v.substring(0,3)+") "+v.substring(3); if(v.length>6)v=v.substring(0,6)+" "+v.substring(6); if(v.length>11)v=v.substring(0,11)+"-"+v.substring(11); i.value = v; }
        
        function sendMsg() { const t = document.getElementById('chat-txt').value; if(!t.trim()) return; socket.emit('send_chat_message', { to: 'admin', text: t, from: 'Admin' }); document.getElementById('chat-txt').value = ''; }
        socket.on('new_chat_message', (d) => { const b=document.getElementById('chat-msgs'); b.innerHTML+=`<div class="msg ${d.from==='Admin'?'admin':'driver'}"><b>${d.from}:</b> ${d.text}</div>`; b.scrollTop=b.scrollHeight; });

        function focarRota(id) {
            routeLayer.clearLayers(); const o = globalData.activeOrders.find(x => x.id === id); if(o) {
                L.marker([-8.0592, -34.8996]).addTo(routeLayer); L.marker([o.lat, o.lng]).addTo(routeLayer); map.setView([o.lat, o.lng], 14);
            }
        }
        
        async function fullReset() { alert("Função desabilitada no modo Banco de Dados (Segurança)."); }

        socket.on('refresh_admin', refreshData);
        // Marcador no mapa agora usa o TELEFONE como chave única (mais seguro)
        socket.on('update_map', (d) => { if(!markers[d.phone]) markers[d.phone] = L.marker([d.lat, d.lng]).addTo(map); else markers[d.phone].setLatLng([d.lat, d.lng]); });
    </script>
</body>
</html>
