<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iGO Driver | Entregador</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        body { background-color: #000; color: white; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .uber-panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #121212; border-radius: 24px 24px 0 0;
            z-index: 100; transition: transform 0.3s ease;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            max-height: 80vh; overflow-y: auto;
        }
        .online-toggle {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; background: #2563eb; padding: 10px 25px;
            border-radius: 50px; font-weight: 800; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }
        .online-toggle.offline { background: #333; box-shadow: none; }
        .order-card {
            background: #1e1e1e; border-radius: 16px; padding: 20px;
            margin: 15px; border-left: 4px solid #2563eb;
        }
        .btn-accept { background: #2563eb; width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 18px; }
        .btn-nav { background: #333; padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        #login-overlay {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="mb-8 text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl font-black">iGO</div>
            <h1 class="text-2xl font-bold">Bem-vindo, Parceiro</h1>
            <p class="text-slate-400">Entre com seu nome para começar</p>
        </div>
        <input type="text" id="driver-name" class="w-full max-w-xs p-4 bg-zinc-900 border border-zinc-800 rounded-xl mb-4 text-center text-white" placeholder="Seu Nome">
        <button onclick="login()" class="w-full max-w-xs bg-white text-black p-4 rounded-xl font-bold text-lg">ENTRAR</button>
    </div>

    <div id="status-toggle" class="online-toggle offline" onclick="toggleOnline()">
        <div class="w-3 h-3 rounded-full bg-slate-500" id="status-dot"></div>
        <span id="status-text">VOCÊ ESTÁ OFFLINE</span>
    </div>

    <div id="map"></div>

    <div class="uber-panel" id="uber-panel">
        <div class="w-12 h-1 bg-zinc-700 rounded-full mx-auto mt-3 mb-4"></div>
        <div id="content-area">
            <div class="p-6 text-center text-slate-400">
                <i class="fas fa-hand-paper mb-3 text-2xl"></i>
                <p>Fique online para receber entregas</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = "https://logistica-igo.onrender.com";
        const urlParams = new URLSearchParams(window.location.search);
        const STORE_SLUG = urlParams.get('store') || 'igo-iphones';
        
        let socket;
        let map;
        let isOnline = false;
        let driverMarker;

        // Inicia o Mapa
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([-8.05428, -34.8813], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        function login() {
            const name = document.getElementById('driver-name').value;
            if(!name) return alert("Digite seu nome!");
            localStorage.setItem('driver_name', name);
            document.getElementById('login-overlay').style.display = 'none';
            initMap();
            connectSocket();
        }

        function connectSocket() {
            socket = io(API_URL);
            socket.emit("join_store", STORE_SLUG);
            
            socket.on("refresh_admin", () => {
                if(isOnline) refreshOrders();
            });
        }

        function toggleOnline() {
            isOnline = !isOnline;
            const btn = document.getElementById('status-toggle');
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');

            if(isOnline) {
                btn.classList.remove('offline');
                dot.classList.replace('bg-slate-500', 'bg-green-400');
                txt.innerText = "VOCÊ ESTÁ ONLINE";
                startLocationTracking();
                refreshOrders();
            } else {
                btn.classList.add('offline');
                dot.classList.replace('bg-green-400', 'bg-slate-500');
                txt.innerText = "VOCÊ ESTÁ OFFLINE";
                stopLocationTracking();
                document.getElementById('content-area').innerHTML = `<div class="p-6 text-center text-slate-400"><p>Você está offline</p></div>`;
            }
        }

        async function refreshOrders() {
            if(!isOnline) return;
            const res = await fetch(`${API_URL}/api/dashboard/${STORE_SLUG}`);
            const data = await res.json();
            
            const list = data.pendingOrders;
            if(list.length === 0) {
                document.getElementById('content-area').innerHTML = `<div class="p-8 text-center text-slate-400"><p>Procurando entregas próximas...</p></div>`;
                return;
            }

            document.getElementById('content-area').innerHTML = list.map(o => `
                <div class="order-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold">${o.client_name}</h3>
                            <p class="text-blue-500 text-sm font-bold uppercase">${o.id}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-green-500 font-black text-xl">R$ ${o.price}</p>
                            <p class="text-xs text-slate-500">Valor da Entrega</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 text-slate-300 mb-6 bg-zinc-800/50 p-3 rounded-lg">
                        <i class="fas fa-location-dot text-blue-500"></i>
                        <span class="text-sm">${o.address}</span>
                    </div>
                    <button onclick="acceptOrder('${o.id}')" class="btn-accept">ACEITAR ENTREGA</button>
                </div>
            `).join('');
        }

        async function acceptOrder(id) {
            const name = localStorage.getItem('driver_name');
            await fetch(`${API_URL}/assign-order`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId: id, driverName: name, store_slug: STORE_SLUG })
            });
            
            // Layout após aceitar (Estilo Waze/Maps)
            document.getElementById('content-area').innerHTML = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-2">Corrida em andamento</h2>
                    <p class="text-slate-400 mb-6">Siga para o endereço do cliente</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openMaps()" class="btn-nav"><i class="fas fa-map"></i> Google Maps</button>
                        <button onclick="openWaze()" class="btn-nav"><i class="fas fa-location-arrow"></i> Waze</button>
                    </div>
                    <button onclick="finishOrder('${id}')" class="w-full mt-6 bg-green-600 p-4 rounded-xl font-bold text-lg">FINALIZAR ENTREGA</button>
                </div>
            `;
        }

        async function finishOrder(id) {
            await fetch(`${API_URL}/complete-delivery`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId: id, store_slug: STORE_SLUG })
            });
            alert("Entrega concluída! Bom trabalho.");
            refreshOrders();
        }

        function startLocationTracking() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    if(driverMarker) {
                        driverMarker.setLatLng([latitude, longitude]);
                    } else {
                        driverMarker = L.marker([latitude, longitude]).addTo(map);
                    }
                    map.panTo([latitude, longitude]);
                    
                    // Envia localização pro seu painel admin
                    socket.emit("driver_location", {
                        store_slug: STORE_SLUG,
                        driver_name: localStorage.getItem('driver_name'),
                        lat: latitude,
                        lng: longitude
                    });
                }, null, { enableHighAccuracy: true });
            }
        }

        function stopLocationTracking() {
            if(driverMarker) map.removeLayer(driverMarker);
            driverMarker = null;
        }

        function openMaps() { window.open(`https://www.google.com/maps/dir/?api=1&destination=Recife`, '_blank'); }
        function openWaze() { window.open(`https://waze.com/ul?q=Recife`, '_blank'); }

        window.onload = () => {
            if(localStorage.getItem('driver_name')) {
                document.getElementById('driver-name').value = localStorage.getItem('driver_name');
            }
        };
    </script>
</body>
</html>
