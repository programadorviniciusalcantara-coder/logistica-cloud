<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGO Driver</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div id="login" class="p-10 text-center">
        <h1 class="text-3xl font-black mb-10 text-gray-800">iGO <span class="text-orange-500">DRIVER</span></h1>
        <input id="name" placeholder="Seu Nome" class="p-4 w-full border rounded-xl mb-3">
        <input id="phone" placeholder="Telefone" class="p-4 w-full border rounded-xl mb-5">
        <button onclick="entrar()" class="w-full bg-black text-white p-5 rounded-xl font-bold">INICIAR TURNO</button>
    </div>

    <div id="painel" class="hidden pb-20">
        <div class="bg-orange-500 text-white text-[10px] p-1 text-center font-bold">MANTENHA ESTA ABA ABERTA</div>
        <div id="map" class="h-64 w-full"></div>
        
        <div class="p-5">
            <div id="corrida" class="bg-white p-6 rounded-2xl shadow-xl border-2 border-orange-500 hidden mb-5">
                <h2 id="cliente" class="font-black text-2xl mb-1 text-gray-800"></h2>
                <p id="endereco" class="text-gray-500 text-sm mb-5"></p>
                <button onclick="finalizar()" class="w-full bg-green-500 text-white p-5 rounded-xl font-bold text-lg">CONCLUIR ENTREGA</button>
            </div>
            
            <p id="status" class="text-center text-gray-400 font-bold uppercase mb-5">Aguardando entrega...</p>

            <div class="bg-white rounded-2xl shadow-lg p-4">
                <h3 class="font-black text-xs text-gray-400 mb-3 uppercase">Chat com Central</h3>
                <div id="chat-box" class="h-40 overflow-y-auto bg-gray-50 rounded-xl p-3 mb-3 text-xs border border-gray-100"></div>
                <div class="flex gap-2">
                    <input id="chat-input" class="flex-1 p-3 bg-gray-100 rounded-xl text-xs outline-none" placeholder="Escreva...">
                    <button onclick="sendChat()" class="bg-orange-500 text-white px-4 rounded-xl font-bold text-xs">ENVIAR</button>
                </div>
            </div>

            <button onclick="sair()" class="mt-10 text-gray-300 text-[10px] underline block mx-auto">Encerrar Turno</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = "https://logistica-igo.onrender.com";
        const socket = io(API);
        let map, marker, destMarker, myPhone, myName, currentOrder = null;

        // PERSISTÃŠNCIA: VERIFICA SE JÃ ESTAVA LOGADO
        window.onload = () => {
            const p = localStorage.getItem('driver_phone');
            const n = localStorage.getItem('driver_name');
            if(p && n) {
                document.getElementById('name').value = n;
                document.getElementById('phone').value = p;
                entrar();
            }
        };

        function entrar() {
            myPhone = document.getElementById('phone').value;
            myName = document.getElementById('name').value;
            if(!myPhone || !myName) return alert("Preencha tudo!");
            
            localStorage.setItem('driver_phone', myPhone);
            localStorage.setItem('driver_name', myName);
            
            document.getElementById('login').classList.add('hidden');
            document.getElementById('painel').classList.remove('hidden');
            init();
        }

        function sair() { localStorage.clear(); location.reload(); }

        function init() {
            if(!map) {
                map = L.map('map', {zoomControl: false}).setView([-8.05, -34.88], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            
            navigator.geolocation.watchPosition(p => {
                const {latitude:lat, longitude:lng} = p.coords;
                socket.emit('driver_location', {store_slug:'igo-iphones', phone:myPhone, name:myName, lat, lng});
                if(marker) marker.setLatLng([lat,lng]); else marker=L.circleMarker([lat,lng],{color:'blue', radius:8}).addTo(map);
            }, e => {}, { enableHighAccuracy: true });
            
            verificar(); 
            setInterval(verificar, 5000);
            socket.emit("join_store", "igo-iphones");
        }

        async function verificar() {
            const res = await fetch(`${API}/api/dashboard/igo-iphones`);
            const data = await res.json();
            const o = data.activeOrders.find(x => x.driver_phone === myPhone);
            
            if(o) {
                currentOrder = o;
                document.getElementById('corrida').classList.remove('hidden');
                document.getElementById('cliente').innerText = o.client_name;
                document.getElementById('endereco').innerText = o.address;
                document.getElementById('status').classList.add('hidden');

                // BANDEIRA DE DESTINO NO MAPA DO MOTOBOY
                if(destMarker) map.removeLayer(destMarker);
                destMarker = L.marker([o.lat, o.lng], {icon: L.divIcon({html: 'ðŸš©', className: 'text-2xl'})}).addTo(map);
            } else {
                currentOrder = null; 
                document.getElementById('corrida').classList.add('hidden');
                document.getElementById('status').classList.remove('hidden');
                if(destMarker) map.removeLayer(destMarker);
            }
        }

        function sendChat() {
            const t = document.getElementById('chat-input').value; if(!t.trim()) return;
            socket.emit('send_chat_message', { from: myName, text: t, store_slug: 'igo-iphones' });
            document.getElementById('chat-input').value = '';
        }

        socket.on('new_chat_message', d => {
            const b = document.getElementById('chat-box');
            b.innerHTML += `<div class="mb-2"><b>${d.from}:</b> ${d.text}</div>`;
            b.scrollTop = b.scrollHeight;
        });

        async function finalizar() {
            if(!currentOrder) return;
            const cod = prompt("CÃ“DIGO DO CLIENTE:");
            if(!cod) return;
            const vRes = await fetch(`${API}/verify-code`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({orderId: currentOrder.id, code: cod})});
            const vData = await vRes.json();
            if(vData.valid) {
                await fetch(`${API}/complete-delivery`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({orderId: currentOrder.id, store_slug:'igo-iphones', signature:'OK'})});
                alert("Entrega Finalizada!"); 
                verificar();
            } else { alert("CÃ“DIGO ERRADO!"); }
        }
    </script>
</body>
</html>
