<style>
    /* ... (CSS anterior) ... */
    
    /* MODAL DE ASSINATURA */
    #sig-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .sig-box { background: white; padding: 20px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
    canvas { border: 2px dashed #ccc; border-radius: 10px; background: #fff; touch-action: none; }
</style>

<div id="sig-modal">
    <div class="sig-box">
        <h2 class="text-xl font-bold mb-4">Finalizar Entrega</h2>
        <p class="text-gray-500 text-sm mb-2">Pe√ßa o c√≥digo ao cliente:</p>
        
        <div class="flex justify-center gap-2 mb-4">
            <input id="code-1" type="tel" maxlength="4" class="w-32 p-3 text-center text-2xl font-black border-2 border-black rounded-xl tracking-widest" placeholder="0000">
        </div>

        <p class="text-gray-500 text-sm mb-2">Assinatura do Cliente:</p>
        <canvas id="sig-canvas" width="300" height="150"></canvas>
        <button onclick="clearSig()" class="text-xs text-red-500 font-bold mb-4 mt-1">Limpar Assinatura</button>

        <button onclick="confirmarEntrega()" class="w-full bg-black text-white p-4 rounded-xl font-bold text-lg">CONFIRMAR</button>
        <button onclick="closeSig()" class="w-full mt-2 p-2 text-gray-500 font-bold">Cancelar</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const API = "https://logistica-igo.onrender.com";
    const STORE = "igo-iphones";
    const socket = io(API);
    let map, marker, destMarker, isOnline = false, watchId, currentOrderId;
    
    // ASSINATURA
    const canvasSig = document.getElementById('sig-canvas');
    const ctxSig = canvasSig.getContext('2d');
    let painting = false;

    // ... (INICIALIZA√á√ÉO DO MAPA E LOGO IGUAIS AO ANTERIOR) ...
    // ... (Use o c√≥digo do motoboy da resposta anterior para map, login, etc) ...

    // --- FUN√á√ÉO NOVA: ABRIR MODAL DE ASSINATURA ---
    function fim(id) {
        currentOrderId = id;
        document.getElementById('sig-modal').style.display = 'flex';
        resizeCanvas();
    }

    function closeSig() { document.getElementById('sig-modal').style.display = 'none'; }
    function clearSig() { ctxSig.clearRect(0, 0, canvasSig.width, canvasSig.height); }

    // --- DESENHAR ASSINATURA ---
    function startPosition(e) { painting = true; draw(e); }
    function finishedPosition() { painting = false; ctxSig.beginPath(); }
    function draw(e) {
        if(!painting) return;
        e.preventDefault();
        const rect = canvasSig.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        ctxSig.lineWidth = 3; ctxSig.lineCap = 'round'; ctxSig.lineTo(x, y); ctxSig.stroke(); ctxSig.beginPath(); ctxSig.moveTo(x, y);
    }

    canvasSig.addEventListener('touchstart', startPosition);
    canvasSig.addEventListener('touchend', finishedPosition);
    canvasSig.addEventListener('touchmove', draw);
    canvasSig.addEventListener('mousedown', startPosition);
    canvasSig.addEventListener('mouseup', finishedPosition);
    canvasSig.addEventListener('mousemove', draw);

    // --- VERIFICAR C√ìDIGO E ENVIAR ---
    async function confirmarEntrega() {
        const code = document.getElementById('code-1').value;
        if(code.length < 4) return alert("Digite o c√≥digo de 4 d√≠gitos!");
        
        // Verifica c√≥digo no servidor
        const res = await fetch(`${API}/verify-code`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ orderId: currentOrderId, code: code })
        });
        const data = await res.json();
        
        if(data.valid) {
            // Se v√°lido, envia a assinatura
            const signature = canvasSig.toDataURL();
            await fetch(`${API}/complete-delivery`, { 
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({store_slug:STORE, orderId: currentOrderId, signature: signature}) 
            });
            closeSig();
            alert("Entrega Realizada com Sucesso! üí∞");
            document.getElementById('code-1').value = '';
            clearSig();
            buscarRota(); // Atualiza tela
        } else {
            alert("‚ùå C√ìDIGO INCORRETO!");
        }
    }
    
    // ... (RESTO DAS FUN√á√ïES login, toggle, buscarRota IGUAIS AO ANTERIOR) ...
    // Certifique-se de manter a fun√ß√£o buscarRota, init, registrarNoServidor, etc.
</script>
