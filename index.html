<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGO iPhones - Acompanhe seu pedido</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --igo-orange: #FF4500;
            --igo-black: #000000;
            --igo-white: #FFFFFF;
        }

        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--igo-white); 
        }

        header {
            background: var(--igo-black);
            color: var(--igo-white);
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid var(--igo-orange);
            font-weight: bold;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }

        #status-container {
            padding: 15px;
            background: var(--igo-white);
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .badge {
            background: var(--igo-orange);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        #map { height: calc(100vh - 150px); width: 100%; }

        /* Estilo para os ícones no mapa claro */
        .pino-loja { background: var(--igo-black); border: 2px solid white; border-radius: 50%; }
        .pino-cliente { background: var(--igo-orange); border: 2px solid white; border-radius: 50%; }
    </style>
</head>
<body>
    <header>iGO iPhones</header>
    
    <div id="status-container">
        Olá, <span id="clientName" style="font-weight:bold;">...</span>! <br>
        <span style="font-size: 0.9rem; color: #666;">Status:</span> 
        <span class="badge" id="statusText">Buscando informações...</span>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        // MAPA CLARO (Estilo White/Positron)
        const map = L.map('map', { zoomControl: false }).setView([-8.0578, -34.8829], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        }).addTo(map);

        let driverMarker, storeMarker, clientMarker;

        if (orderId) {
            socket.emit('joinOrder', orderId);

            socket.on('orderUpdate', (data) => {
                document.getElementById('clientName').innerText = data.clientName;
                document.getElementById('statusText').innerText = data.status;

                // Pino da Loja (Preto)
                if (!storeMarker) {
                    storeMarker = L.circleMarker([data.storeLat, data.storeLng], {
                        color: '#000', fillColor: '#000', fillOpacity: 1, radius: 8
                    }).addTo(map).bindPopup('Loja iGO');
                }

                // Pino do Cliente (Laranja)
                if (!clientMarker) {
                    clientMarker = L.circleMarker([data.destLat, data.destLng], {
                        color: '#FF4500', fillColor: '#FF4500', fillOpacity: 1, radius: 10
                    }).addTo(map).bindPopup('Seu Endereço');
                }

                // Motorista em tempo real
                if (data.driverCoords) {
                    const pos = [data.driverCoords.lat, data.driverCoords.lng];
                    if (driverMarker) {
                        driverMarker.setLatLng(pos);
                    } else {
                        driverMarker = L.marker(pos).addTo(map).bindPopup('Entregador iGO');
                    }
                    map.fitBounds([clientMarker.getLatLng(), driverMarker.getLatLng()], { padding: [70, 70] });
                }
            });
        }
    </script>
</body>
</html>
